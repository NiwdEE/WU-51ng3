import socket
from aes_ige_mal import forge
import re
from binascii import unhexlify, hexlify

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
challenge_addr = ("dyn-02.xmas.root-me.org", 14427)
sock.connect(challenge_addr)

P = b"role=guest&name=JustARandomUser\x0a" # Oracle plaintext
T = b"role=admin&name=GiveMeFlagIbegU\x0a" # Target plaintext

def recv(buff=2048, end=''):
    response = sock.recv(buff).decode()
    print(response, end=end)
    return response

def send(data, end=b"\n"):
    sock.sendall(data + end)
    print(data.decode())

recv()
send(b"1")
recv()
send(P, end=b"")
ciph_res = recv()
ciphertext = re.search(r"Ciphertext: ([0-9a-f]+)", ciph_res).group(1).encode()
# print("[+] Cipher recieved: ", ciphertext)

C = unhexlify(ciphertext)
(M, mIV, R) = forge(T, P, C)

print("\n\n------------------")
print("Oracle plaintext:", P)
print("Oracle cipher:", ciphertext)
print("Malicious cipher:", hexlify(M))
print("Malicious IV:", hexlify(mIV))
print("Should decode to:", R)
print("------------------\n")

send(b"2")
recv()

send(hexlify(mIV))
recv()

send(hexlify(M))
recv()




